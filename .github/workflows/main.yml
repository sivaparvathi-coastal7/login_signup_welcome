name: Playwright Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    
    # ðŸ³ Official Playwright Docker Image
    container:
      image: mcr.microsoft.com/playwright:v1.40.0-jammy

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    # ðŸ‘‡ THIS IS THE FIXED STEP
    - name: Install Dependencies
      run: |
        # 1. Install pip using apt-get (Fixes 'No module named pip')
        apt-get update && apt-get install -y python3-pip
        
        # 2. Now we can use pip to install your stack
        python3 -m pip install --upgrade pip
        python3 -m pip install playwright pytest pytest-playwright fastapi httpx
        
        # 3. Install Chromium
        python3 -m playwright install --with-deps chromium

    - name: Create Output Directory
      run: mkdir -p scripts

    - name: Generate Test Script
      run: python3 generate_script.py

    - name: Run Universal Tests
      id: run-tests
      run: python3 scripts/test_universal_autogenerated.py --headless

    # ==========================================================
    # ðŸš¨ TRIAGE SECTION
    # ==========================================================
    
    - name: Checkout Triage Repo
      if: failure()
      uses: actions/checkout@v4
      with:
        repository: sivaparvathi-coastal7/
        token: ${{ secrets.TRIAGE_PAT }}
        path: triage-folder

    - name: Push Failure Report
      if: failure()
      run: |
        echo "ðŸš¨ Processing Failure..."
        if [ -f "artifacts/report.html" ]; then
          echo "ðŸ“„ Report found."
        else
          echo "âš ï¸ No report found. Creating dummy error log."
          mkdir -p artifacts
          echo "Critical Failure in Run ${{ github.run_id }}" > artifacts/report.html
        fi

        cd triage-folder
        cp ../artifacts/report.html ./failure_report_${{ github.run_id }}.html
        
        git config user.name "Auto-Triage Bot"
        git config user.email "bot@github.com"
        git add .
        git commit -m "ðŸš¨ Test Failed: Run ${{ github.run_id }}"
        git push
