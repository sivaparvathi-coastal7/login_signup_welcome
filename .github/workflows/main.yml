name: Playwright Universal Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    
    # ðŸ³ Use the official container so Browsers & Python are pre-installed
    container:
      image: mcr.microsoft.com/playwright:v1.40.0-jammy

    steps:
    # 1. Check out your code
    - name: Checkout Code
      uses: actions/checkout@v4

    # 2. Install Python Dependencies
    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        pip install playwright
        # We install pytest just in case, though your script uses custom logic
        pip install pytest

    # 3. Create 'scripts' folder (Safe-guard)
    # Your python code tries to write to 'scripts/', this ensures it exists.
    - name: Create Scripts Directory
      run: mkdir -p scripts

    # 4. Generate the Test Script
    - name: Generate Test Script
      run: python generate_script.py

    # 5. Run the Generated Tests
    # We use 'python' because this is a custom runner, not a pytest file.
    - name: Run Universal Tests
      id: run-tests
      run: python scripts/test_universal_autogenerated.py --headless

    # ==========================================================
    # ðŸš¨ TRIAGE SECTION: Only runs if the tests FAIL
    # ==========================================================
    
    - name: Checkout Triage Repo
      if: failure()
      uses: actions/checkout@v4
      with:
        # âš ï¸ UPDATE THIS with your real Triage Repo name
        repository: sivaparvathi-coastal7/https://github.com/Aswini-Kamireddy/triage_engine
        token: ${{ secrets.TRIAGE_PAT }}
        path: triage-folder

    - name: Push Failure Report
      if: failure()
      run: |
        echo "ðŸš¨ Tests Failed. Pushing report to Triage Repo..."
        
        # 1. Check if the report exists (Your script creates artifacts/report.html)
        if [ -f "artifacts/report.html" ]; then
          echo "ðŸ“„ Report found."
        else
          echo "âš ï¸ No report found, creating dummy report."
          mkdir -p artifacts
          echo "Test Run ${{ github.run_id }} Failed" > artifacts/report.html
        fi

        # 2. Move report to Triage folder
        cd triage-folder
        cp ../artifacts/report.html ./failure-report-${{ github.run_id }}.html
        
        # 3. Git Push
        git config user.name "Auto-Triage Bot"
        git config user.email "bot@github.com"
        git add .
        git commit -m "ðŸš¨ Failure Detected: Run ${{ github.run_id }}"
        git push
