name: Playwright Tests (Full Production)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    
    # ðŸ³ Official Playwright Docker Image
    container:
      image: mcr.microsoft.com/playwright:v1.40.0-jammy
    
    # ðŸ”‘ Pass the Secret to the Container Environment
    env:
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }} 

    steps:
    # 1. Checkout Code
    - name: Checkout Code
      uses: actions/checkout@v4

    # 2. Install Dependencies (Fixed for Docker)
    - name: Install Dependencies
      run: |
        echo "â¬‡ï¸ Installing System Tools..."
        apt-get update && apt-get install -y python3-pip git

        echo "â¬‡ï¸ Installing Python Libraries..."
        python3 -m pip install --upgrade pip
        # We include 'groq' so your generator script works
        python3 -m pip install playwright pytest pytest-playwright fastapi httpx groq
        
        echo "â¬‡ï¸ Installing Browsers..."
        python3 -m playwright install --with-deps chromium

    # 3. Create Scripts Directory
    - name: Create Output Directory
      run: mkdir -p scripts

    # 4. Generate Test Script (Uses GROQ_API_KEY)
    - name: Generate Test Script
      run: python3 generate_script.py

    # 5. Run the Generated Tests
    - name: Run Universal Tests
      id: run-tests
      # Running with python3 since it is a custom runner script
      run: python3 scripts/test_universal_autogenerated.py --headless

    # ==========================================================
    # ðŸš¨ TRIAGE SECTION (Only runs if tests FAIL)
    # ==========================================================
    
    - name: Checkout Triage Repo
      if: failure()
      uses: actions/checkout@v4
      with:
        repository: sivaparvathi-coastal7/https://Aswini-Kamireddy
        token: ${{ secrets.TRIAGE_PAT }}
        path: triage-folder

    - name: Push Failure Report
      if: failure()
      run: |
        echo "ðŸš¨ Processing Failure..."
        
        # Safety check: Triage folder must exist
        if [ ! -d "triage-folder" ]; then
          echo "âŒ Error: Triage folder missing. Check your TRIAGE_PAT secret."
          exit 1
        fi

        # Check/Create Report
        if [ -f "artifacts/report.html" ]; then
          echo "ðŸ“„ Report found."
        else
          echo "âš ï¸ No report found. Creating dummy error log."
          mkdir -p artifacts
          echo "Critical Failure in Run ${{ github.run_id }}" > artifacts/report.html
        fi

        # Move and Push
        cd triage-folder
        cp ../artifacts/report.html ./failure_report_${{ github.run_id }}.html
        
        git config user.name "Auto-Triage Bot"
        git config user.email "bot@github.com"
        git add .
        git commit -m "ðŸš¨ Test Failed: Run ${{ github.run_id }}"
        git push
