name: Playwright Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    
    # ðŸ³ Official Playwright Docker Image
    container:
      image: mcr.microsoft.com/playwright:v1.40.0-jammy

    steps:
    # 1. Check out Code
    - name: Checkout Code
      uses: actions/checkout@v4

    # 2. Install Dependencies (Fixed PIP Error)
    - name: Install Python Dependencies
      run: |
        echo "â¬‡ï¸ Installing Dependencies..."
        # We use 'python3 -m pip' to avoid 'pip: not found' errors
        python3 -m pip install --upgrade pip
        
        # Install your stack requirements
        python3 -m pip install playwright pytest pytest-playwright fastapi httpx
        
        # Install browsers (Docker image has them, but this links them)
        python3 -m playwright install --with-deps chromium

    # 3. Create Scripts Directory (Safety check)
    - name: Create Output Directory
      run: mkdir -p scripts

    # 4. Generate the Test Script
    - name: Generate Test Script
      run: python3 generate_script.py

    # 5. Run Tests
    # Note: Using python3 directly because your script is a custom runner
    - name: Run Universal Tests
      id: run-tests
      run: python3 scripts/test_universal_autogenerated.py --headless

    # ==========================================================
    # ðŸš¨ TRIAGE SECTION (Only runs if tests FAIL)
    # ==========================================================
    
    - name: Checkout Triage Repo
      if: failure()
      uses: actions/checkout@v4
      with:
        repository: sivaparvathi-coastal7/https://github.com/Aswini-Kamireddy/triage_engine
        token: ${{ secrets.TRIAGE_PAT }}
        path: triage-folder

    - name: Push Failure Report
      if: failure()
      run: |
        echo "ðŸš¨ Processing Failure..."
        
        # Check if report exists, else create a placeholder
        if [ -f "artifacts/report.html" ]; then
          echo "ðŸ“„ Report found."
        else
          echo "âš ï¸ No report found. Creating dummy error log."
          mkdir -p artifacts
          echo "Critical Failure in Run ${{ github.run_id }}" > artifacts/report.html
        fi

        # Copy to Triage Repo
        cd triage-folder
        cp ../artifacts/report.html ./failure_report_${{ github.run_id }}.html
        
        # Push to Git
        git config user.name "Auto-Triage Bot"
        git config user.email "bot@github.com"
        git add .
        git commit -m "ðŸš¨ Test Failed: Run ${{ github.run_id }}"
        git push
